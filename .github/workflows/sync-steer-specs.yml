name: syncSteerSpecs
on:
  push:
    branches: ["sync-for-steer-specs"]
  workflow_dispatch:
    inputs:
      dir_name:
        description: 'Sync Directories'
        required: true
        default: 'steering_docs'
        type: choice
        options:
            - steering_docs
            - scenarios


permissions:
  id-token: write

jobs:
  run_job_with_aws:
    runs-on: ubuntu-latest
    env:
      sdk_name: ${{ github.event.inputs.sdk_name || 'steering_docs' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5 
        with:
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE }}
          aws-region: us-west-2

      - name: Set SDK and language mapping for S3
        run: |
          if [ "$dir_name" == "steering_docs" ]; then
              echo "S3_NAME=steering-docs" >> $GITHUB_ENV
          elif [ "$dir_name" == "scenarios" ]; then
              echo "S3_NAME=final-specs" >> $GITHUB_ENV
          fi

      - name: Filter SPECIFICATION.md files for scenarios
        if: ${{ github.event.inputs.dir_name == 'scenarios' }}
        run: |
          find ./scenarios -name "SPECIFICATION.md" -exec cp --parents {} ./filtered_scenarios/ \;

      - name: Upload/Sync to S3
        run: |
          if [ "$dir_name" == "scenarios" ]; then
            aws s3 sync "./filtered_scenarios/scenarios/" "s3://$S3_NAME-bucket/" --delete
          else
            aws s3 sync "./$dir_name/" "s3://$S3_NAME-bucket/" --delete
          fi

      - name: Sync Knowledge Base Data Source
        run: |
          aws lambda invoke \
            --function-name KB_Updater \
            --payload "{\"language\":\"$S3_NAME\",\"region\":\"us-west-2\"}" \
            --cli-binary-format raw-in-base64-out \
            response.json
          
          echo "Knowledge Base sync initiated"
          cat response.json